# Monoc LocSaver

白黒トーン基調のモダンな位置情報記録アプリです。

## 機能

*   **位置情報の自動記録**: 移動経路を記録し、地図上に表示します。
*   **写真記録**: 撮影した写真を場所とともに記録します。
*   **タイムライン表示**: 1日の行動履歴をリスト形式で確認できます。
*   **省電力設計**: 必要最低限のセンサー利用でバッテリー消費を抑えます。
*   **完全オフライン**: データは端末内にのみ保存されます。
*   **バディ探索機能（NEW）**: 同じアプリを入れた人同士でBluetoothを使って接続し、迷子になった際に相手の方向・距離を表示します。

## バディ探索機能について

ショッピングモールや遊園地などで家族や友人と離れてしまった時に、相手の位置を見つけるための機能です。

### 使い方

1. ホーム画面の👥ボタン（青いボタン）をタップして「バディを探す」画面を開きます
2. 「周囲を探索」ボタンをタップして、近くにいる同じアプリのユーザーを探します
3. 見つかったユーザーをタップして接続をリクエストします
4. 相手が接続を承認すると、分かりやすいリスト表示で相手の位置と方向がリアルタイムで表示されます
5. 画面右上のアイコンでリスト表示とレーダー表示を切り替えられます

### 技術仕様

*   **通信方式**: Google Nearby Connections API（Bluetooth Low Energy + WiFi Direct）
*   **方位測定**: IMUセンサーフュージョン（Madgwickアルゴリズム）+ 磁気センサー
*   **距離測定**: GPS + RSSI（電波強度）+ UWB（対応端末のみ）
*   **超高精度モード**: UWB（Ultra-Wideband）対応端末で±数cmの精度を実現
*   **有効距離**: 約100m以内（環境により変動）
*   **対応プラットフォーム**: Android 5.0以上 / iOS 12.0以上
*   **UWB対応**: Android 12以上でUWBハードウェア搭載端末

### UWB超高精度モード

**対応端末**:
- Samsung Galaxy Note 20 Ultra（2020年）以降
- Google Pixel 6 Pro（2021年）以降
- Google Pixel 7 Pro / 8 Pro
- その他Android 12+でUWBチップ搭載モデル

**精度**:
- 通常モード: ±2-15m（GPS + RSSI）
- **UWB超高精度モード: ±数cm〜10cm**

UWB対応端末の場合、画面右上に🎯アイコンが表示されます。タップすることで超高精度モードを有効化できます。

### 最新の改善点（2026年1月1日）

#### v1.2.0 - 表示の改善とUWB対応（2026年1月1日）
- **分かりやすいリスト表示に変更**
  - レーダー表示からリストベースのUIに変更（デフォルト）
  - 距離に応じた色分け表示（緑=近い、オレンジ=中距離、赤=遠い）
  - 大きな方向矢印で直感的に方角を表示
  - 「すぐ近く！」「近い」「中距離」などの分かりやすいラベル
  - リスト⇔レーダー表示の切り替え可能

- **UWB（Ultra-Wideband）超高精度モード追加**
  - UWB対応端末で±数cmの距離測定を実現
  - 自動的にUWBハードウェアを検出
  - UWB利用時は画面に「UWB超高精度」バッジを表示
  - 通常モードとの自由な切り替え
  - Samsung Galaxy Note 20 Ultra、Pixel 6 Pro以降の端末で利用可能

#### v1.1.0 - 高精度化対応（2025年12月）
#### クラッシュ対策の強化
- **位置情報取得の安全性向上**
  - タイムアウト処理を追加（7秒でタイムアウト）
  - 位置情報サービス無効時の適切なハンドリング
  - 権限拒否時の段階的なエラー処理

- **Nearby Connectionsの安定性向上**
  - アドバタイズ/ディスカバリー開始時のタイムアウト処理（10秒）
  - 接続初期化時のエラーハンドリング強化
  - ペイロード送信時のnullチェック追加

- **Compassの安全な処理**
  - Streamがnullの場合の適切な処理
  - エラー発生時の継続的な動作保証
  - 初期化失敗時のログ出力

- **UI層の改善**
  - サービス初期化失敗時のユーザーフィードバック
  - 探索開始失敗時の詳細なエラーメッセージ
  - マウント状態の適切なチェック

これらの改善により、実機でのAPK実行時のクラッシュを大幅に削減し、より安定した動作を実現しています。

## ビルド方法 (GitHub Actions)

このリポジトリはGitHub Actionsを使用してAPKファイルを自動生成するように構成されています。

1.  このフォルダの内容をGitHubリポジトリにプッシュします。
2.  GitHubの「Actions」タブを開きます。
3.  「Build Android APK」ワークフローが自動的に開始されます（または手動で実行します）。
4.  ビルドが完了すると、Artifactsとして `app-release.apk` がダウンロード可能になります。

## ローカル開発環境のセットアップ (オプション)

もしローカルにFlutter環境がある場合は、以下の手順で実行できます。

1.  依存関係の取得:
    ```bash
    flutter pub get
    ```
2.  アプリの実行:
    ```bash
    flutter run
    ```

## 使用素材

*   **Font**: DotGothic16
*   **Icons**: SVG Repo (AppPartsIconsフォルダ内)
